package org.polarsys.chess.diagram.ui.commands;

import org.eclipse.core.commands.ExecutionEvent;
import org.eclipse.core.runtime.IProgressMonitor;
import org.eclipse.uml2.uml.Class;
import org.polarsys.chess.diagram.ui.docGenerators.CHESSDiagramModel;
import org.polarsys.chess.diagram.ui.utils.ExportDialogUtils;
import org.polarsys.chess.service.internal.utils.SelectionUtil;
import org.polarsys.chess.verificationService.model.ChessSystemModel;

import eu.fbk.eclipse.standardtools.ModelTranslatorToOcra.services.OCRATranslatorService;
import eu.fbk.eclipse.standardtools.commands.AbstractAsyncJobCommand;
import eu.fbk.eclipse.standardtools.diagram.ui.dialog.ModelToDocumentDialog;
import eu.fbk.eclipse.standardtools.diagram.ui.docGenerators.DocumentGeneratorServiceFromOssModel;
import eu.fbk.eclipse.standardtools.dialogs.MessageTimeModelDialog;
import eu.fbk.eclipse.standardtools.utils.DirectoryUtil;
import eu.fbk.tools.editor.oss.oss.OSS;

public class GenerateDocumentCommand extends AbstractAsyncJobCommand {

	
	private SelectionUtil selectionUtil = SelectionUtil.getInstance();
	private ChessSystemModel chessToOCRAModelTranslator = ChessSystemModel.getInstance();
	private OCRATranslatorService ocraTranslatorService = OCRATranslatorService.getInstance(chessToOCRAModelTranslator);
	private ExportDialogUtils exportDialogUtils = ExportDialogUtils.getInstance();
	
	private DirectoryUtil directoryUtils = DirectoryUtil.getInstance();
	
	private DocumentGeneratorServiceFromOssModel documentGeneratorService ;
	/**
	 * @param commandName
	 */
	public GenerateDocumentCommand() {
		super("Generate Documentation");
	}

	@Override
	public void execJobCommand(ExecutionEvent event, IProgressMonitor monitor) throws Exception {
		
		
		Class umlSelectedComponent = selectionUtil.getUmlComponentFromSelectedObject(event);
		boolean isDiscreteTime = MessageTimeModelDialog.openQuestion();
		
		OSS ossModel = ocraTranslatorService.getOssModel(umlSelectedComponent, isDiscreteTime, monitor);
		
		ModelToDocumentDialog parameterDialog = exportDialogUtils.getCompiledModelToDocumentDialog();

		if (!parameterDialog.goAhead()) {
			return;
		}

		String docFormat = parameterDialog.getDocumentFormat();
		String imageExtension = ".svg";
		if (docFormat.equals("tex")) {
			imageExtension = ".png";
		}

		// setShowLeafComponents(showLeafComponents);
		String outputDirectoryName = exportDialogUtils.getDirectoryNameFromDialog();
		// setDirectoryName(directoryName);
		if ((outputDirectoryName == null) || outputDirectoryName.isEmpty()) {
			return;
		}
		
		String currentProjectName = directoryUtils.getCurrentProjectName();
		System.out.println("currentProjectName: "+currentProjectName);
		
		
		documentGeneratorService = DocumentGeneratorServiceFromOssModel.getInstance(CHESSDiagramModel.getInstance(), ossModel);
		documentGeneratorService.setParametersBeforeDocumentGeneration(parameterDialog.getShowPortLabels(), parameterDialog.getAutomaticPortLabelLayout(), outputDirectoryName, imageExtension, parameterDialog.getShowLeafComponents());

		documentGeneratorService.createDocumentFile(currentProjectName, docFormat, ossModel.getSystem(), monitor);
	}

}
